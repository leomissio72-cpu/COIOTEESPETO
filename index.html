<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão - Restaurante</title>
    
    <style>
        /* ... (manter todos os estilos existentes) ... */

        /* NOVOS ESTILOS PARA PARCELAS */
        .parcelas-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--secondary);
        }

        .parcelas-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .parcela-option {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .parcela-option:hover {
            border-color: var(--secondary);
            background-color: #f8f9fa;
        }

        .parcela-option.selected {
            border-color: var(--success);
            background-color: #e8f5e8;
        }

        /* ... (manter todos os estilos existentes) ... */
    </style>
</head>
<body>
    <!-- ... (manter todo o HTML existente) ... -->

    <!-- Modal para forma de pagamento -->
    <div id="modal-pagamento" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Forma de Pagamento</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <div class="payment-options">
                <div class="payment-option" data-payment="dinheiro">
                    <h4>Dinheiro</h4>
                </div>
                <div class="payment-option" data-payment="pix">
                    <h4>PIX</h4>
                </div>
                <div class="payment-option" data-payment="debito">
                    <h4>Cartão de Débito</h4>
                </div>
                <div class="payment-option" data-payment="credito">
                    <h4>Cartão de Crédito</h4>
                </div>
            </div>
            
            <!-- NOVA SEÇÃO PARA PARCELAS (APARECE APENAS PARA DÉBITO) -->
            <div id="parcelas-section" class="parcelas-section hidden">
                <h4>Número de Parcelas (Débito)</h4>
                <div class="parcelas-options">
                    <div class="parcela-option" data-parcelas="1">1x</div>
                    <div class="parcela-option" data-parcelas="2">2x</div>
                    <div class="parcela-option" data-parcelas="3">3x</div>
                    <div class="parcela-option" data-parcelas="4">4x</div>
                    <div class="parcela-option" data-parcelas="5">5x</div>
                    <div class="parcela-option" data-parcelas="6">6x</div>
                </div>
                <div id="info-parcelas" style="margin-top: 10px; font-weight: bold;"></div>
            </div>
            
            <!-- Seção de Desconto -->
            <div class="desconto-section">
                <h4>Aplicar Desconto</h4>
                <div class="desconto-input-group">
                    <input type="number" id="percentual-desconto" min="0" max="100" step="0.5" placeholder="% de desconto">
                    <button class="btn btn-warning" id="aplicar-desconto">Aplicar</button>
                </div>
                <div id="desconto-info" style="margin-top: 10px;"></div>
            </div>
            
            <!-- QR Code PIX (aparece apenas quando PIX é selecionado) -->
            <div id="pix-code-container" class="pix-code hidden">
                <h4>Pagamento via PIX - Coiote BBQ</h4>
                <p>Escaneie o QR Code abaixo para pagar:</p>
                <div class="qr-code-container">
                    <img src="https://i.imgur.com/4R3p0gG.png" alt="QR Code PIX Coiote BBQ" id="qrcode-image">
                </div>
                <p style="margin-top: 10px; font-size: 12px; color: #666;">Ou copie o código PIX:</p>
                <div class="pix-code-text" id="pix-code-text">
                    00020126720014br.gov.bcb.pix01368293e1c5-117b-4f71-b43c-cebf9db754ef0210Coiote BBQ27600016BR.COM.PAGSEGURO013601D9105A-85D7-4B8C-B2F5-D33A62A56A075204599953039865802BR592559.080.908 GIOVANA TEIXEI6011Santo Andre62290525PAGS000000000251125113140630466D9
                </div>
                <button class="btn btn-primary" onclick="copiarCodigoPix()" style="margin-top: 10px;">Copiar Código PIX</button>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" id="confirmar-pagamento" style="flex: 1;">Confirmar Pagamento</button>
                <button class="btn btn-warning" id="cancelar-pagamento">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // ... (manter todas as variáveis e funções existentes) ...

        // NOVAS VARIÁVEIS PARA PARCELAS
        let numeroParcelas = 1;

        // Função para mostrar/ocultar seção de parcelas
        function toggleParcelasSection() {
            const parcelasSection = document.getElementById('parcelas-section');
            if (formaPagamento === 'debito') {
                parcelasSection.classList.remove('hidden');
                atualizarInfoParcelas();
            } else {
                parcelasSection.classList.add('hidden');
                numeroParcelas = 1; // Reset para 1 parcela se não for débito
            }
        }

        // Função para atualizar informações das parcelas
        function atualizarInfoParcelas() {
            const comandas = JSON.parse(localStorage.getItem('comandas')) || [];
            const comanda = comandas[comandaAtual];
            
            if (!comanda || comanda.itens.length === 0) return;
            
            const totalComanda = comanda.itens.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
            const totalComDesconto = totalComDesconto > 0 ? totalComDesconto : totalComanda;
            const valorParcela = totalComDesconto / numeroParcelas;
            
            const infoParcelas = document.getElementById('info-parcelas');
            infoParcelas.innerHTML = `
                ${numeroParcelas}x de R$ ${valorParcela.toFixed(2)} = R$ ${totalComDesconto.toFixed(2)}
            `;
        }

        // Modificar a função abrirModalPagamento para incluir parcelas
        function abrirModalPagamento(index) {
            const comandas = JSON.parse(localStorage.getItem('comandas')) || [];
            const comanda = comandas[index];
            
            if (comanda.itens.length === 0) {
                alert('Não é possível fechar uma comanda sem itens.');
                return;
            }
            
            // Resetar desconto
            percentualDesconto = 0;
            valorDesconto = 0;
            totalComDesconto = 0;
            document.getElementById('percentual-desconto').value = '';
            document.getElementById('desconto-info').innerHTML = '';
            
            // Resetar parcelas
            numeroParcelas = 1;
            
            // Fechar modal da comanda
            document.getElementById('modal-comanda').style.display = 'none';
            
            // Abrir modal de pagamento
            const modalPagamento = document.getElementById('modal-pagamento');
            modalPagamento.style.display = 'flex';
            
            // Resetar seleção de pagamento
            formaPagamento = null;
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Esconder seções inicialmente
            document.getElementById('pix-code-container').classList.add('hidden');
            document.getElementById('parcelas-section').classList.add('hidden');
            
            // Configurar eventos de seleção de pagamento
            document.querySelectorAll('.payment-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    formaPagamento = this.getAttribute('data-payment');
                    
                    // Mostrar QR Code PIX se selecionado
                    if (formaPagamento === 'pix') {
                        document.getElementById('pix-code-container').classList.remove('hidden');
                    } else {
                        document.getElementById('pix-code-container').classList.add('hidden');
                    }
                    
                    // Mostrar/ocultar seção de parcelas
                    toggleParcelasSection();
                });
            });
            
            // Configurar eventos das parcelas
            document.querySelectorAll('.parcela-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.parcela-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    numeroParcelas = parseInt(this.getAttribute('data-parcelas'));
                    atualizarInfoParcelas();
                });
            });
            
            // Selecionar primeira parcela por padrão
            document.querySelector('.parcela-option[data-parcelas="1"]').classList.add('selected');
            
            // Configurar eventos dos botões
            document.getElementById('confirmar-pagamento').onclick = () => fecharComanda(index);
            document.getElementById('cancelar-pagamento').onclick = () => {
                modalPagamento.style.display = 'none';
                document.getElementById('modal-comanda').style.display = 'flex';
            };
            
            // Configurar evento do botão de desconto
            document.getElementById('aplicar-desconto').onclick = aplicarDesconto;
            
            // Fechar modal
            document.querySelector('#modal-pagamento .close-btn').onclick = () => {
                modalPagamento.style.display = 'none';
                document.getElementById('modal-comanda').style.display = 'flex';
            };
        }

        // Modificar a função fecharComanda para incluir parcelas
        async function fecharComanda(index) {
            if (!formaPagamento) {
                alert('Por favor, selecione uma forma de pagamento.');
                return;
            }
            
            const comandas = JSON.parse(localStorage.getItem('comandas')) || [];
            const comanda = comandas[index];
            
            const total = comanda.itens.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
            
            // Calcular total final (com desconto, se aplicado)
            const totalFinal = totalComDesconto > 0 ? totalComDesconto : total;
            
            // Registrar venda
            const venda = {
                comandaId: comanda.id,
                cliente: comanda.cliente,
                itens: [...comanda.itens],
                total: total,
                desconto: valorDesconto,
                percentualDesconto: percentualDesconto,
                totalFinal: totalFinal,
                formaPagamento: formaPagamento,
                numeroParcelas: formaPagamento === 'debito' ? numeroParcelas : 1, // ARMAZENAR NÚMERO DE PARCELAS
                data: new Date().toISOString()
            };
            
            const vendas = JSON.parse(localStorage.getItem('vendas')) || [];
            vendas.push(venda);
            localStorage.setItem('vendas', JSON.stringify(vendas));
            
            // Salvar venda no Google Sheets
            await salvarVendaGoogle(venda);
            
            // Remover comanda
            comandas.splice(index, 1);
            localStorage.setItem('comandas', JSON.stringify(comandas));
            
            // Fechar modal
            document.getElementById('modal-pagamento').style.display = 'none';
            
            let mensagem = `Comanda fechada com sucesso! Total: R$ ${total.toFixed(2)}`;
            if (percentualDesconto > 0) {
                mensagem += `\nDesconto aplicado: ${percentualDesconto}% (-R$ ${valorDesconto.toFixed(2)})`;
                mensagem += `\nTotal com desconto: R$ ${totalFinal.toFixed(2)}`;
            }
            mensagem += `\nForma de pagamento: ${formaPagamento}`;
            
            // Adicionar informação de parcelas se for débito
            if (formaPagamento === 'debito' && numeroParcelas > 1) {
                const valorParcela = totalFinal / numeroParcelas;
                mensagem += `\nParcelado em ${numeroParcelas}x de R$ ${valorParcela.toFixed(2)}`;
            }
            
            alert(mensagem);
            carregarComandas();
            atualizarDashboard();
        }

        // Modificar a função carregarRelatorios para mostrar parcelas
        function carregarRelatorios() {
            const dataInicio = document.getElementById('data-inicio').value;
            const dataFim = document.getElementById('data-fim').value;
            
            let vendas = JSON.parse(localStorage.getItem('vendas')) || [];
            
            // Filtrar por data se especificado
            if (dataInicio) {
                vendas = vendas.filter(venda => venda.data >= dataInicio);
            }
            
            if (dataFim) {
                // Adicionar um dia para incluir vendas do dia final
                const fim = new Date(dataFim);
                fim.setDate(fim.getDate() + 1);
                vendas = vendas.filter(venda => venda.data < fim.toISOString());
            }
            
            const tabela = document.getElementById('relatorio-vendas');
            tabela.innerHTML = '';
            
            if (vendas.length === 0) {
                tabela.innerHTML = '<tr><td colspan="9" style="text-align: center;">Nenhuma venda encontrada</td></tr>';
                return;
            }
            
            vendas.forEach((venda, index) => {
                const data = new Date(venda.data);
                const dataFormatada = data.toLocaleDateString('pt-BR');
                
                // Formatar forma de pagamento
                let pagamentoFormatado = '';
                let parcelasInfo = '';
                
                switch(venda.formaPagamento) {
                    case 'dinheiro':
                        pagamentoFormatado = '<span class="badge badge-success">Dinheiro</span>';
                        break;
                    case 'pix':
                        pagamentoFormatado = '<span class="badge badge-info">PIX</span>';
                        break;
                    case 'debito':
                        pagamentoFormatado = '<span class="badge badge-warning">Débito</span>';
                        if (venda.numeroParcelas > 1) {
                            parcelasInfo = `${venda.numeroParcelas}x`;
                        }
                        break;
                    case 'credito':
                        pagamentoFormatado = '<span class="badge badge-danger">Crédito</span>';
                        break;
                    default:
                        pagamentoFormatado = '<span class="badge">N/A</span>';
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${dataFormatada}</td>
                    <td>#${venda.comandaId}</td>
                    <td>${venda.cliente || 'Cliente não informado'}</td>
                    <td>R$ ${venda.total.toFixed(2)}</td>
                    <td>${venda.desconto > 0 ? `R$ ${venda.desconto.toFixed(2)} (${venda.percentualDesconto}%)` : 'R$ 0,00'}</td>
                    <td>R$ ${venda.totalFinal.toFixed(2)}</td>
                    <td>${pagamentoFormatado}</td>
                    <td>${parcelasInfo}</td>
                    <td>
                        <button class="btn btn-primary" onclick="verDetalhesVenda(${index})">Ver Detalhes</button>
                    </td>
                `;
                tabela.appendChild(tr);
            });
        }

        // Modificar a função verDetalhesVenda para incluir parcelas
        function verDetalhesVenda(index) {
            const vendas = JSON.parse(localStorage.getItem('vendas')) || [];
            const venda = vendas[index];
            
            // Formatar forma de pagamento
            let pagamentoTexto = '';
            let parcelasInfo = '';
            
            switch(venda.formaPagamento) {
                case 'dinheiro':
                    pagamentoTexto = 'Dinheiro';
                    break;
                case 'pix':
                    pagamentoTexto = 'PIX';
                    break;
                case 'debito':
                    pagamentoTexto = 'Cartão de Débito';
                    if (venda.numeroParcelas > 1) {
                        const valorParcela = venda.totalFinal / venda.numeroParcelas;
                        parcelasInfo = `<p><strong>Parcelado em:</strong> ${venda.numeroParcelas}x de R$ ${valorParcela.toFixed(2)}</p>`;
                    }
                    break;
                case 'credito':
                    pagamentoTexto = 'Cartão de Crédito';
                    break;
                default:
                    pagamentoTexto = 'Não informado';
            }
            
            const modal = document.getElementById('modal-venda');
            const container = document.getElementById('detalhes-venda');
            
            let descontoInfo = '';
            if (venda.desconto > 0) {
                descontoInfo = `
                    <p><strong>Desconto Aplicado:</strong> ${venda.percentualDesconto}% (R$ ${venda.desconto.toFixed(2)})</p>
                `;
            }
            
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p><strong>Comanda:</strong> #${venda.comandaId}</p>
                    <p><strong>Cliente:</strong> ${venda.cliente || 'Cliente não informado'}</p>
                    <p><strong>Data:</strong> ${new Date(venda.data).toLocaleString('pt-BR')}</p>
                    <p><strong>Forma de Pagamento:</strong> ${pagamentoTexto}</p>
                    ${parcelasInfo}
                    ${descontoInfo}
                </div>
                
                <h4>Itens:</h4>
                <ul>
                    ${venda.itens.map(item => `
                        <li>${item.quantidade}x ${item.nome} - R$ ${item.preco.toFixed(2)} = R$ ${(item.preco * item.quantidade).toFixed(2)}</li>
                    `).join('')}
                </ul>
                <p><strong>Total Bruto:</strong> R$ ${venda.total.toFixed(2)}</p>
                ${venda.desconto > 0 ? `<p><strong>Desconto:</strong> R$ ${venda.desconto.toFixed(2)}</p>` : ''}
                <p><strong>Total Final:</strong> R$ ${venda.totalFinal.toFixed(2)}</p>
            `;
            
            modal.style.display = 'flex';
            
            // Fechar modal
            document.querySelector('#modal-venda .close-btn').onclick = () => {
                modal.style.display = 'none';
            };
        }

        // Modificar a função exportarRelatorio para incluir parcelas
        function exportarRelatorio() {
            let vendas = JSON.parse(localStorage.getItem('vendas')) || [];
            
            const dataInicio = document.getElementById('data-inicio').value;
            const dataFim = document.getElementById('data-fim').value;
            
            // Filtrar por data se especificado
            if (dataInicio) {
                vendas = vendas.filter(venda => venda.data >= dataInicio);
            }
            
            if (dataFim) {
                // Adicionar um dia para incluir vendas do dia final
                const fim = new Date(dataFim);
                fim.setDate(fim.getDate() + 1);
                vendas = vendas.filter(venda => venda.data < fim.toISOString());
            }
            
            if (vendas.length === 0) {
                alert('Nenhuma venda para exportar.');
                return;
            }
            
            // Criar CSV
            let csv = 'Data,Comanda,Cliente,Total,Desconto,Total Final,Forma de Pagamento,Parcelas\n';
            
            vendas.forEach(venda => {
                const data = new Date(venda.data);
                const dataFormatada = data.toLocaleDateString('pt-BR');
                
                // Formatar forma de pagamento
                let pagamentoTexto = '';
                let parcelasInfo = '';
                
                switch(venda.formaPagamento) {
                    case 'dinheiro':
                        pagamentoTexto = 'Dinheiro';
                        break;
                    case 'pix':
                        pagamentoTexto = 'PIX';
                        break;
                    case 'debito':
                        pagamentoTexto = 'Cartão de Débito';
                        if (venda.numeroParcelas > 1) {
                            parcelasInfo = `${venda.numeroParcelas}x`;
                        }
                        break;
                    case 'credito':
                        pagamentoTexto = 'Cartão de Crédito';
                        break;
                    default:
                        pagamentoTexto = 'Não informado';
                }
                
                csv += `"${dataFormatada}","${venda.comandaId}","${venda.cliente || ''}","${venda.total.toFixed(2)}","${venda.desconto.toFixed(2)}","${venda.totalFinal.toFixed(2)}","${pagamentoTexto}","${parcelasInfo}"\n`;
            });
            
            // Criar e baixar arquivo
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `relatorio_vendas_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ... (manter o restante do código existente) ...
    </script>
</body>
</html>
